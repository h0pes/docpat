# ==============================================================================
# PostgreSQL 17 Configuration for Production
# Medical Practice Management System (MPMS)
# Optimized for security, performance, and HIPAA compliance
# ==============================================================================

# -----------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# SSL/TLS (for production, enable SSL)
# ssl = on
# ssl_cert_file = '/var/lib/postgresql/server.crt'
# ssl_key_file = '/var/lib/postgresql/server.key'
# ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
# ssl_prefer_server_ciphers = on

# -----------------------------------------------------------------------------
# RESOURCE USAGE (MEMORY)
# -----------------------------------------------------------------------------
shared_buffers = 256MB              # 25% of RAM for dedicated server
effective_cache_size = 1GB          # 50-75% of RAM
maintenance_work_mem = 64MB
work_mem = 4MB
huge_pages = try

# -----------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL)
# -----------------------------------------------------------------------------
wal_level = replica                 # For point-in-time recovery
fsync = on                          # Force synchronous writes
synchronous_commit = on
wal_sync_method = fsync
full_page_writes = on
wal_compression = on
wal_buffers = 16MB

# Checkpoints
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# Archiving (for backups)
archive_mode = on
archive_command = 'cp %p /backups/wal_archive/%f'

# -----------------------------------------------------------------------------
# QUERY TUNING
# -----------------------------------------------------------------------------
random_page_cost = 1.1              # For SSD storage
effective_io_concurrency = 200      # For SSD storage
default_statistics_target = 100

# Planner costs
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = off

# What to log
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_lock_waits = on
log_statement = 'ddl'               # Log DDL statements
log_min_duration_statement = 1000   # Log queries > 1 second

# -----------------------------------------------------------------------------
# AUTOVACUUM
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 60s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# -----------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.simple'

# -----------------------------------------------------------------------------
# LOCK MANAGEMENT
# -----------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 64

# -----------------------------------------------------------------------------
# VERSION AND PLATFORM COMPATIBILITY
# -----------------------------------------------------------------------------
# (PostgreSQL 17 specific settings)

# -----------------------------------------------------------------------------
# ERROR HANDLING
# -----------------------------------------------------------------------------
exit_on_error = off
restart_after_crash = on

# -----------------------------------------------------------------------------
# SECURITY
# -----------------------------------------------------------------------------
# Password encryption
password_encryption = scram-sha-256

# Statement timeout (prevent runaway queries)
statement_timeout = 30000           # 30 seconds

# Idle session timeout
idle_in_transaction_session_timeout = 300000  # 5 minutes

# -----------------------------------------------------------------------------
# EXTENSIONS
# -----------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements
pg_stat_statements.track = all
pg_stat_statements.max = 10000
