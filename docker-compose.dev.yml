# ==============================================================================
# Docker Compose Configuration - Development
# Medical Practice Management System (MPMS)
# ==============================================================================
#
# Development-specific features:
# - Hot-reloading for backend and frontend
# - Exposed ports for direct access
# - Volume mounts for source code
# - Relaxed security for easier debugging
# - Simplified logging
#
# Usage:
#   docker-compose -f docker-compose.dev.yml up        # Start dev environment
#   docker-compose -f docker-compose.dev.yml down      # Stop dev environment
#   docker-compose -f docker-compose.dev.yml logs -f   # View logs
#
# ==============================================================================

# ==============================================================================
# Services
# ==============================================================================
services:
  # ----------------------------------------------------------------------------
  # PostgreSQL Database - Development
  # ----------------------------------------------------------------------------
  postgres:
    image: postgres:17-alpine
    container_name: mpms-postgres-dev
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-mpms_dev}
      POSTGRES_USER: ${POSTGRES_USER:-mpms_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dev_password_change_me}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"

    volumes:
      - postgres_dev_data:/var/lib/postgresql/data

    networks:
      - dev_network

    ports:
      - "5433:5432"  # Mapped to 5433 to avoid conflict with host PostgreSQL

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mpms_user}"]
      interval: 5s
      timeout: 3s
      retries: 5

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # ----------------------------------------------------------------------------
  # Redis Cache - Development
  # ----------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: mpms-redis-dev
    restart: unless-stopped

    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-dev_redis_password}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

    volumes:
      - redis_dev_data:/data

    networks:
      - dev_network

    ports:
      - "6380:6379"  # Mapped to 6380 to avoid potential host conflicts

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ----------------------------------------------------------------------------
  # Backend API - Development (with hot-reloading)
  # ----------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.backend.dev
      args:
        - RUST_VERSION=1.90

    image: mpms-backend:dev
    container_name: mpms-backend-dev
    restart: unless-stopped

    environment:
      # Development mode
      RUST_LOG: debug
      RUST_BACKTRACE: 1
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8000

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-mpms_user}:${POSTGRES_PASSWORD:-dev_password_change_me}@postgres:5432/${POSTGRES_DB:-mpms_dev}

      # Redis
      REDIS_URL: redis://:${REDIS_PASSWORD:-dev_redis_password}@redis:6379

      # Secrets (development only - use secure values in production)
      JWT_SECRET: dev_jwt_secret_change_in_production_32chars
      JWT_REFRESH_SECRET: dev_jwt_refresh_secret_change_in_production
      ENCRYPTION_KEY: dev_encryption_key_32_bytes_b64=

      # Argon2 password hashing parameters
      ARGON2_MEMORY_COST: ${ARGON2_MEMORY_COST:-65536}
      ARGON2_TIME_COST: ${ARGON2_TIME_COST:-3}
      ARGON2_PARALLELISM: ${ARGON2_PARALLELISM:-4}

    volumes:
      # Mount source code for hot-reloading
      - ./backend/src:/app/src:ro
      - ./backend/Cargo.toml:/app/Cargo.toml:ro
      - ./backend/Cargo.lock:/app/Cargo.lock:ro
      - ./backend/migrations:/app/migrations:ro
      - backend_dev_target:/app/target  # Cache Rust build artifacts

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    networks:
      - dev_network

    ports:
      - "8000:8000"  # Exposed for direct API access

    # Override command for development with cargo-watch
    command: cargo watch -x run

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # ----------------------------------------------------------------------------
  # Frontend - Development (with HMR)
  # ----------------------------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.frontend.dev
      args:
        - NODE_VERSION=22

    image: mpms-frontend:dev
    container_name: mpms-frontend-dev
    restart: unless-stopped

    environment:
      VITE_API_URL: http://localhost:8000/api/v1
      VITE_ENV: development

    volumes:
      # Mount source code for hot-reloading
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.ts:/app/vite.config.ts
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tailwind.config.js:/app/tailwind.config.js
      - ./frontend/postcss.config.js:/app/postcss.config.js
      - ./frontend/package.json:/app/package.json
      - ./frontend/package-lock.json:/app/package-lock.json
      - frontend_dev_node_modules:/app/node_modules  # Cache node_modules

    networks:
      - dev_network

    ports:
      - "5173:5173"  # Vite dev server port

    # Vite dev server command
    command: npm run dev -- --host 0.0.0.0

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # ----------------------------------------------------------------------------
  # Nginx - Development (optional, for testing reverse proxy)
  # ----------------------------------------------------------------------------
  nginx:
    image: nginx:1.27-alpine
    container_name: mpms-nginx-dev
    restart: unless-stopped

    volumes:
      - ./infrastructure/nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
      - ./infrastructure/nginx/proxy.dev.conf:/etc/nginx/conf.d/default.conf:ro

    depends_on:
      - backend
      - frontend

    networks:
      - dev_network

    ports:
      - "8080:80"  # Development HTTP only

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# ==============================================================================
# Networks - Single development network
# ==============================================================================
networks:
  dev_network:
    driver: bridge
    name: mpms_dev_network

# ==============================================================================
# Volumes - Development data storage
# ==============================================================================
volumes:
  postgres_dev_data:
    name: mpms_postgres_dev_data

  redis_dev_data:
    name: mpms_redis_dev_data

  backend_dev_target:
    name: mpms_backend_dev_target

  frontend_dev_node_modules:
    name: mpms_frontend_dev_node_modules
